# vim: set ts=2 sts=2 sw=2 et:

test_image_versioned: &test_image_versioned triton:${DRONE_BRANCH}-${DRONE_BUILD_NUMBER}-${DRONE_COMMIT_SHA:0:8}

workspace:
  base: /triton
  path: src

services:
  gcloud:
    image: quay.io/postmates/gcloud-pubsub-emulator
    environment:
      - HOST_PORT=0.0.0.0:8085
      - DATA_DIR=/tmp/gcloud/pubsub

pipeline:
  test-docker-image:
    image: docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      docker build -t triton:${DRONE_BRANCH}-${DRONE_BUILD_NUMBER}-${DRONE_COMMIT_SHA:0:8} -f Dockerfile.dev .

  test-gcloud:
    image: alpine:3.5
    commands:
      - ping -c 3 gcloud

  test-unit:
    image: *test_image_versioned
    environment:
      - DISABLE_GRPC=1
      - PUBSUB_EMULATOR_HOST=gcloud:8085
    commands:
      - testify tests
